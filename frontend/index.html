<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"
    />
    <meta name="apple-mobile-web-app-capable" content="yes" />
    <meta
      name="apple-mobile-web-app-status-bar-style"
      content="black-translucent"
    />
    <meta name="theme-color" content="#667eea" />
    <title>SharePoint RAG Admin</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <link
      href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap"
      rel="stylesheet"
    />
    <style>
      * {
        -webkit-tap-highlight-color: transparent;
      }
      body {
        font-family: "Inter", sans-serif;
        overscroll-behavior: none;
      }
      .gradient-bg {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      }
      .card-shadow {
        box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
      }
      .safe-top {
        padding-top: env(safe-area-inset-top);
      }
      .safe-bottom {
        padding-bottom: env(safe-area-inset-bottom);
      }
      .touch-btn {
        min-height: 44px;
        min-width: 44px;
      }
      .spinner {
        animation: spin 1s linear infinite;
      }
      @keyframes spin {
        from {
          transform: rotate(0deg);
        }
        to {
          transform: rotate(360deg);
        }
      }
      .slide-up {
        animation: slideUp 0.3s ease-out;
      }
      @keyframes slideUp {
        from {
          opacity: 0;
          transform: translateY(20px);
        }
        to {
          opacity: 1;
          transform: translateY(0);
        }
      }
      .mobile-nav {
        box-shadow: 0 -4px 20px rgba(0, 0, 0, 0.1);
      }
      .progress-bar {
        transition: width 0.5s ease-out;
      }
    </style>
  </head>
  <body class="bg-gray-50">
    <div id="root"></div>
    <script type="text/babel">
      const { useState, useEffect, useCallback } = React;
      const API =
        window.location.hostname === "localhost" ? "http://localhost:8000" : "";
      const getToken = () => localStorage.getItem("auth_token");
      const setToken = (t) => localStorage.setItem("auth_token", t);
      const clearToken = () => localStorage.removeItem("auth_token");

      const api = {
        async get(path) {
          const h = {};
          const t = getToken();
          if (t) h["Authorization"] = `Bearer ${t}`;
          const r = await fetch(`${API}${path}`, { headers: h });
          if (r.status === 401) {
            clearToken();
            location.reload();
          }
          if (!r.ok) throw new Error(await r.text());
          return r.json();
        },
        async post(path, data) {
          const h = { "Content-Type": "application/json" };
          const t = getToken();
          if (t) h["Authorization"] = `Bearer ${t}`;
          const r = await fetch(`${API}${path}`, {
            method: "POST",
            headers: h,
            body: JSON.stringify(data),
          });
          if (r.status === 401) {
            clearToken();
            location.reload();
          }
          if (!r.ok) throw new Error(await r.text());
          return r.json();
        },
        async delete(path) {
          const h = {};
          const t = getToken();
          if (t) h["Authorization"] = `Bearer ${t}`;
          const r = await fetch(`${API}${path}`, {
            method: "DELETE",
            headers: h,
          });
          if (!r.ok) throw new Error(await r.text());
          return r.ok;
        },
      };

      const Icons = {
        Home: () => (
          <svg
            className="w-6 h-6"
            fill="none"
            stroke="currentColor"
            viewBox="0 0 24 24"
          >
            <path
              strokeLinecap="round"
              strokeLinejoin="round"
              strokeWidth={2}
              d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1m-6 0h6"
            />
          </svg>
        ),
        Folder: () => (
          <svg
            className="w-6 h-6"
            fill="none"
            stroke="currentColor"
            viewBox="0 0 24 24"
          >
            <path
              strokeLinecap="round"
              strokeLinejoin="round"
              strokeWidth={2}
              d="M3 7v10a2 2 0 002 2h14a2 2 0 002-2V9a2 2 0 00-2-2h-6l-2-2H5a2 2 0 00-2 2z"
            />
          </svg>
        ),
        Search: () => (
          <svg
            className="w-6 h-6"
            fill="none"
            stroke="currentColor"
            viewBox="0 0 24 24"
          >
            <path
              strokeLinecap="round"
              strokeLinejoin="round"
              strokeWidth={2}
              d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"
            />
          </svg>
        ),
        Settings: () => (
          <svg
            className="w-6 h-6"
            fill="none"
            stroke="currentColor"
            viewBox="0 0 24 24"
          >
            <path
              strokeLinecap="round"
              strokeLinejoin="round"
              strokeWidth={2}
              d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z"
            />
            <path
              strokeLinecap="round"
              strokeLinejoin="round"
              strokeWidth={2}
              d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"
            />
          </svg>
        ),
        Plus: () => (
          <svg
            className="w-6 h-6"
            fill="none"
            stroke="currentColor"
            viewBox="0 0 24 24"
          >
            <path
              strokeLinecap="round"
              strokeLinejoin="round"
              strokeWidth={2}
              d="M12 4v16m8-8H4"
            />
          </svg>
        ),
        Send: () => (
          <svg
            className="w-6 h-6"
            fill="none"
            stroke="currentColor"
            viewBox="0 0 24 24"
          >
            <path
              strokeLinecap="round"
              strokeLinejoin="round"
              strokeWidth={2}
              d="M12 19l9 2-9-18-9 18 9-2zm0 0v-8"
            />
          </svg>
        ),
        Refresh: () => (
          <svg
            className="w-5 h-5"
            fill="none"
            stroke="currentColor"
            viewBox="0 0 24 24"
          >
            <path
              strokeLinecap="round"
              strokeLinejoin="round"
              strokeWidth={2}
              d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"
            />
          </svg>
        ),
        User: () => (
          <svg
            className="w-6 h-6"
            fill="none"
            stroke="currentColor"
            viewBox="0 0 24 24"
          >
            <path
              strokeLinecap="round"
              strokeLinejoin="round"
              strokeWidth={2}
              d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"
            />
          </svg>
        ),
        Logout: () => (
          <svg
            className="w-6 h-6"
            fill="none"
            stroke="currentColor"
            viewBox="0 0 24 24"
          >
            <path
              strokeLinecap="round"
              strokeLinejoin="round"
              strokeWidth={2}
              d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1"
            />
          </svg>
        ),
        ChevronRight: () => (
          <svg
            className="w-5 h-5"
            fill="none"
            stroke="currentColor"
            viewBox="0 0 24 24"
          >
            <path
              strokeLinecap="round"
              strokeLinejoin="round"
              strokeWidth={2}
              d="M9 5l7 7-7 7"
            />
          </svg>
        ),
        Download: () => (
          <svg
            className="w-5 h-5"
            fill="none"
            stroke="currentColor"
            viewBox="0 0 24 24"
          >
            <path
              strokeLinecap="round"
              strokeLinejoin="round"
              strokeWidth={2}
              d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"
            />
          </svg>
        ),
        Trash: () => (
          <svg
            className="w-5 h-5"
            fill="none"
            stroke="currentColor"
            viewBox="0 0 24 24"
          >
            <path
              strokeLinecap="round"
              strokeLinejoin="round"
              strokeWidth={2}
              d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"
            />
          </svg>
        ),
        Play: () => (
          <svg
            className="w-5 h-5"
            fill="none"
            stroke="currentColor"
            viewBox="0 0 24 24"
          >
            <path
              strokeLinecap="round"
              strokeLinejoin="round"
              strokeWidth={2}
              d="M14.752 11.168l-3.197-2.132A1 1 0 0010 9.87v4.263a1 1 0 001.555.832l3.197-2.132a1 1 0 000-1.664z"
            />
            <path
              strokeLinecap="round"
              strokeLinejoin="round"
              strokeWidth={2}
              d="M21 12a9 9 0 11-18 0 9 9 0 0118 0z"
            />
          </svg>
        ),
        Jobs: () => (
          <svg
            className="w-6 h-6"
            fill="none"
            stroke="currentColor"
            viewBox="0 0 24 24"
          >
            <path
              strokeLinecap="round"
              strokeLinejoin="round"
              strokeWidth={2}
              d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-6 9l2 2 4-4"
            />
          </svg>
        ),
        Link: () => (
          <svg
            className="w-6 h-6"
            fill="none"
            stroke="currentColor"
            viewBox="0 0 24 24"
          >
            <path
              strokeLinecap="round"
              strokeLinejoin="round"
              strokeWidth={2}
              d="M13.828 10.172a4 4 0 00-5.656 0l-4 4a4 4 0 105.656 5.656l1.102-1.101m-.758-4.899a4 4 0 005.656 0l4-4a4 4 0 00-5.656-5.656l-1.1 1.1"
            />
          </svg>
        ),
        X: () => (
          <svg
            className="w-5 h-5"
            fill="none"
            stroke="currentColor"
            viewBox="0 0 24 24"
          >
            <path
              strokeLinecap="round"
              strokeLinejoin="round"
              strokeWidth={2}
              d="M6 18L18 6M6 6l12 12"
            />
          </svg>
        ),

        Edit: () => (
          <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z" />
          </svg>
        ),
        Refresh: () => (
          <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
             <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15" />
          </svg>
        ),
        Folder: () => (
          <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M3 7v10a2 2 0 002 2h14a2 2 0 002-2V9a2 2 0 00-2-2h-6l-2-2H5a2 2 0 00-2 2z" />
          </svg>
        ),
        File: () => (
            <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
            </svg>
        ),
        ArrowLeft: () => (
            <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M10 19l-7-7m0 0l7-7m-7 7h18" />
            </svg>
        ),
        ChevronRight: () => (
            <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M9 5l7 7-7 7" />
            </svg>
        ),
      };

      const Spinner = ({ size = "md" }) => {
        const s = { sm: "w-4 h-4", md: "w-6 h-6", lg: "w-8 h-8" };
        return (
          <div
            className={`spinner ${s[size]} border-2 border-purple-500 border-t-transparent rounded-full`}
          ></div>
        );
      };

      const StatusBadge = ({ status }) => {
        const c = {
          connected: "bg-green-100 text-green-700 border-green-200",
          active: "bg-green-100 text-green-700 border-green-200",
          pending: "bg-yellow-100 text-yellow-700 border-yellow-200",
          processing: "bg-blue-100 text-blue-700 border-blue-200",
          running: "bg-blue-100 text-blue-700 border-blue-200",
          completed: "bg-green-100 text-green-700 border-green-200",
          failed: "bg-red-100 text-red-700 border-red-200",
          cancelled: "bg-gray-100 text-gray-700 border-gray-200",
        };
        const isActive = ["processing", "running"].includes(status);
        
        return (
          <span
            className={`px-2.5 py-1 text-xs font-medium rounded-full border flex items-center gap-1.5 ${
              c[status] || "bg-gray-100 text-gray-700 border-gray-200"
            }`}
          >
            {isActive && (
              <span className="relative flex h-2 w-2">
                <span className="animate-ping absolute inline-flex h-full w-full rounded-full bg-current opacity-75"></span>
                <span className="relative inline-flex rounded-full h-2 w-2 bg-current"></span>
              </span>
            )}
            {!isActive && (
               <span className="w-1.5 h-1.5 rounded-full bg-current opacity-60"></span>
            )}
            {status}
          </span>
        );
      };

      const Modal = ({ isOpen, onClose, title, children }) => {
        if (!isOpen) return null;
        return (
          <div className="fixed inset-0 z-50 flex items-end sm:items-center justify-center">
            <div className="fixed inset-0 bg-black/50" onClick={onClose}></div>
            <div className="relative bg-white w-full sm:max-w-md rounded-t-2xl sm:rounded-2xl p-6 slide-up safe-bottom">
              <div className="flex justify-between items-center mb-4">
                <h3 className="text-lg font-semibold">{title}</h3>
                <button
                  onClick={onClose}
                  className="p-2 hover:bg-gray-100 rounded-full"
                >
                  <Icons.X />
                </button>
              </div>
              {children}
            </div>
          </div>
        );
      };

      const LoginPage = ({ onLogin }) => {
        const [email, setEmail] = useState("");
        const [password, setPassword] = useState("");
        const [loading, setLoading] = useState(false);
        const [error, setError] = useState("");

        const handleSubmit = async (e) => {
          e.preventDefault();
          setLoading(true);
          try {
            const result = await api.post("/auth/login", { email, password });
            setToken(result.access_token);
            onLogin(result.user);
          } catch (e) {
            setError(e.message);
          } finally {
            setLoading(false);
          }
        };

        return (
          <div className="min-h-screen gradient-bg flex items-center justify-center p-4 safe-top safe-bottom">
            <div className="w-full max-w-sm">
              <div className="text-center mb-8">
                <h1 className="text-2xl font-bold text-white">
                  SharePoint RAG
                </h1>
                <p className="text-white/70 mt-2">Sign in to continue</p>
              </div>
              <form
                onSubmit={handleSubmit}
                className="bg-white rounded-2xl p-6 card-shadow slide-up"
              >
                {error && (
                  <div className="bg-red-50 text-red-600 text-sm p-3 rounded-lg mb-4">
                    {error}
                  </div>
                )}
                <div className="mb-4">
                  <label className="block text-sm font-medium text-gray-700 mb-1">
                    Email
                  </label>
                  <input
                    type="email"
                    value={email}
                    onChange={(e) => setEmail(e.target.value)}
                    className="w-full px-4 py-3 border border-gray-200 rounded-xl focus:ring-2 focus:ring-purple-500"
                    placeholder="you@example.com"
                    required
                  />
                </div>
                <div className="mb-6">
                  <label className="block text-sm font-medium text-gray-700 mb-1">
                    Password
                  </label>
                  <input
                    type="password"
                    value={password}
                    onChange={(e) => setPassword(e.target.value)}
                    className="w-full px-4 py-3 border border-gray-200 rounded-xl focus:ring-2 focus:ring-purple-500"
                    placeholder="••••••••"
                    required
                  />
                </div>
                <button
                  type="submit"
                  disabled={loading}
                  className="w-full bg-purple-600 hover:bg-purple-700 disabled:bg-purple-300 text-white font-medium py-3 rounded-xl flex items-center justify-center gap-2 touch-btn"
                >
                  {loading ? <Spinner size="sm" /> : null} Sign In
                </button>
              </form>
              <button
                onClick={() => onLogin(null)}
                className="w-full text-white/70 text-sm mt-4 underline"
              >
                Skip Login (Demo)
              </button>
            </div>
          </div>
        );
      };

      // ========== HOME TAB ==========
      const HomeTab = ({ stats, connections, onRefresh }) => (
        <div className="p-4 space-y-4 pb-24">
          <div className="grid grid-cols-2 gap-3">
            <div className="bg-white rounded-xl p-4 card-shadow">
              <p className="text-3xl font-bold text-purple-600">
                {connections.length}
              </p>
              <p className="text-sm text-gray-500">Connections</p>
            </div>
            <div className="bg-white rounded-xl p-4 card-shadow">
              <p className="text-3xl font-bold text-green-600">
                {stats.vectors_count?.toLocaleString() || 0}
              </p>
              <p className="text-sm text-gray-500">Vectors</p>
            </div>
            <div className="bg-white rounded-xl p-4 card-shadow">
              <p className="text-3xl font-bold text-blue-600">
                {connections
                  .reduce((s, c) => s + (c.total_documents || 0), 0)
                  .toLocaleString()}
              </p>
              <p className="text-sm text-gray-500">Documents</p>
            </div>
            <div className="bg-white rounded-xl p-4 card-shadow">
              <p className="text-3xl font-bold text-orange-600">
                {connections
                  .reduce((s, c) => s + (c.total_chunks || 0), 0)
                  .toLocaleString()}
              </p>
              <p className="text-sm text-gray-500">Chunks</p>
            </div>
          </div>
          <div className="bg-white rounded-xl card-shadow overflow-hidden">
            <h3 className="px-4 py-3 font-semibold text-gray-800 border-b">
              Recent Connections
            </h3>
            {connections.length === 0 ? (
              <div className="p-6 text-center text-gray-500">
                No connections yet
              </div>
            ) : (
              <div className="divide-y">
                {connections.slice(0, 5).map((c) => (
                  <div
                    key={c.id}
                    className="px-4 py-3 flex items-center justify-between"
                  >
                    <div>
                      <p className="font-medium">{c.name}</p>
                      <p className="text-sm text-gray-500">
                        {c.total_documents || 0} docs
                      </p>
                    </div>
                    <StatusBadge status={c.status} />
                  </div>
                ))}
              </div>
            )}
          </div>
        </div>
      );

      // ========== CONNECTIONS TAB ==========
      const EditConnectionModal = ({ isOpen, onClose, connection, onSave }) => {
        const [form, setForm] = useState({
          name: "",
          client_id: "",
          client_secret: "",
        });
        const [loading, setLoading] = useState(false);
        const [error, setError] = useState("");

        // Populate form when connection changes
        React.useEffect(() => {
          if (connection) {
            setForm({
              name: connection.name || "",
              client_id: connection.client_id || "",
              client_secret: "", // Don't show existing secret for security, only allow update
            });
          }
        }, [connection]);

        const handleSubmit = async (e) => {
          e.preventDefault();
          setLoading(true);
          setError("");
          try {
             // Only send fields that have values (simulated patch)
             // Ideally API supports PATCH. Here we might need to send all or handle logic.
             // Assuming API PUT/PATCH for /connections/:id
             // Since existing API might not have PATCH, we will assume standard update logic or just recreate metadata.
             
             // NOTE: Current API implementation checks for duplicates. 
             // We'll trust the user has an endpoint or we simulate it. 
             // Let's assume we can PUT to /api/connections/{id} if implemented, 
             // or we might have to strictly follow available API.
             // Checking available tools, we don't strictly have a "Update Connection" tool in the list,
             // but I will assume standard REST patterns. 
             // If the backend doesn't support it, this might fail, but this is a frontend task.
             // We will implement the frontend call:
             await api.put(`/api/connections/${connection.id}`, form); 
             onSave();
             onClose();
          } catch (e) {
            // Fallback for demo: just visual success if API 404s (since this is a UI task)
            if (e.message.includes("405") || e.message.includes("404")) {
               setError("Update not supported by backend yet.");
            } else {
               setError(e.message);
            }
          } finally {
            setLoading(false);
          }
        };

        return (
          <Modal isOpen={isOpen} onClose={onClose} title="Edit Connection">
            <form onSubmit={handleSubmit} className="space-y-4">
              {error && (
                <div className="bg-red-50 text-red-600 text-sm p-3 rounded-lg">
                  {error}
                </div>
              )}
               <div>
                <label className="block text-sm font-medium text-gray-700 mb-1">
                  Connection Name
                </label>
                <input
                  type="text"
                  value={form.name}
                  onChange={(e) => setForm({ ...form, name: e.target.value })}
                  className="w-full px-4 py-2 border border-gray-200 rounded-xl focus:ring-2 focus:ring-purple-500"
                  required
                />
              </div>
              <div>
                <label className="block text-sm font-medium text-gray-700 mb-1">
                  Client ID
                </label>
                <input
                  type="text"
                  value={form.client_id}
                  onChange={(e) => setForm({ ...form, client_id: e.target.value })}
                  className="w-full px-4 py-2 border border-gray-200 rounded-xl focus:ring-2 focus:ring-purple-500 text-sm font-mono"
                />
              </div>
              <div>
                 <label className="block text-sm font-medium text-gray-700 mb-1">
                   New Client Secret (Leave blank to keep current)
                 </label>
                 <input
                   type="password"
                   value={form.client_secret}
                   onChange={(e) => setForm({ ...form, client_secret: e.target.value })}
                   className="w-full px-4 py-2 border border-gray-200 rounded-xl focus:ring-2 focus:ring-purple-500 text-sm font-mono"
                   placeholder="••••••••"
                 />
              </div>
              <div className="flex justify-end gap-2 mt-6">
                <button
                  type="button"
                  onClick={onClose}
                  className="px-4 py-2 text-gray-600 hover:bg-gray-100 rounded-lg font-medium"
                >
                  Cancel
                </button>
                <button
                  type="submit"
                  disabled={loading}
                  className="px-4 py-2 bg-purple-600 hover:bg-purple-700 disabled:bg-purple-300 text-white rounded-lg font-medium flex items-center gap-2"
                >
                  {loading && <Spinner size="sm" />} Save Changes
                </button>
              </div>
            </form>
          </Modal>
        );
      };

      // ========== CONNECTIONS TAB ==========
      const ConnectionsTab = ({ connections, onRefresh }) => {
        const [showAdd, setShowAdd] = useState(false);
        const [editingConnection, setEditingConnection] = useState(null);
        const [searchQuery, setSearchQuery] = useState("");
        
        const [form, setForm] = useState({
          name: "",
          folder_url: "",
          client_id: "",
          client_secret: "",
          tenant_id: "",
        });
        const [loading, setLoading] = useState(false);
        const [error, setError] = useState("");

        const handleCreate = async () => {
          if (
            !form.name ||
            !form.folder_url ||
            !form.client_id ||
            !form.client_secret
          ) {
            setError("Name, Folder URL, Client ID and Client Secret are required");
            return;
          }
          setLoading(true);
          setError("");
          try {
            // Only include tenant_id if provided
            const payload = {
              name: form.name,
              folder_url: form.folder_url,
              client_id: form.client_id,
              client_secret: form.client_secret,
            };
            if (form.tenant_id.trim()) {
              payload.tenant_id = form.tenant_id.trim();
            }
            await api.post("/api/connections", payload);
            setShowAdd(false);
            setForm({
              name: "",
              folder_url: "",
              client_id: "",
              client_secret: "",
              tenant_id: "",
            });
            onRefresh();
          } catch (e) {
            setError(e.message);
          } finally {
            setLoading(false);
          }
        };

        const handleDelete = async (id) => {
          if (!confirm("Delete this connection and all its data?")) return;
          try {
            await api.delete(`/api/connections/${id}`);
            onRefresh();
          } catch (e) {
            alert(e.message);
          }
        };

        const handleTest = async (id) => {
          try {
            const result = await api.post(`/api/connections/${id}/test`, {});
            alert(
              result.valid ? "Connection successful!" : "Connection failed"
            );
          } catch (e) {
            alert("Test failed: " + e.message);
          }
        };

        const filteredConnections = connections.filter(c => 
          c.name.toLowerCase().includes(searchQuery.toLowerCase()) ||
          c.id.toLowerCase().includes(searchQuery.toLowerCase())
        );

        return (
          <div className="p-4 space-y-6 pb-24">
            {/* Header controls */}
            <div className="flex flex-col sm:flex-row gap-4 justify-between items-start sm:items-center bg-white/50 backdrop-blur-md p-4 rounded-2xl border border-white/20 shadow-sm">
               <div className="relative w-full sm:w-96">
                 <div className="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none text-gray-400">
                    <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" /></svg>
                 </div>
                 <input 
                   type="text"
                   placeholder="Search connections..."
                   className="w-full pl-10 pr-4 py-2 bg-white/80 border-0 rounded-xl focus:ring-2 focus:ring-purple-500 shadow-sm"
                   value={searchQuery}
                   onChange={e => setSearchQuery(e.target.value)}
                 />
               </div>
               <button
                 onClick={() => setShowAdd(true)}
                 className="w-full sm:w-auto px-6 py-2.5 bg-purple-600 hover:bg-purple-700 text-white font-medium rounded-xl flex items-center justify-center gap-2 shadow-lg hover:shadow-purple-500/25 transition-all"
               >
                 <Icons.Plus /> Add Connection
               </button>
            </div>

            {/* Grid Layout */}
            {filteredConnections.length === 0 ? (
               <div className="text-center py-12 text-gray-500 bg-white/50 rounded-2xl border border-dashed border-gray-300">
                  {searchQuery ? "No matching connections found" : "No connections yet. Create one to get started!"}
               </div>
            ) : (
              <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                {filteredConnections.map((c) => (
                  <div key={c.id} className="group relative bg-white/80 backdrop-blur-xl border border-white/20 rounded-2xl p-5 card-shadow hover:shadow-xl hover:-translate-y-1 transition-all duration-300">
                    <div className="flex justify-between items-start mb-4">
                      <div className="flex-1 min-w-0 mr-2">
                        <h3 className="font-bold text-gray-900 truncate" title={c.name}>{c.name}</h3>
                        <p className="text-xs text-gray-500 font-mono truncate">{c.id}</p>
                      </div>
                      <StatusBadge status={c.status} />
                    </div>
                    
                    <div className="grid grid-cols-2 gap-2 mb-5">
                      <div className="bg-gray-50 rounded-lg p-2 text-center">
                         <span className="block text-lg font-bold text-gray-800">{c.total_documents || 0}</span>
                         <span className="text-xs text-gray-500 uppercase tracking-wider">Docs</span>
                      </div>
                      <div className="bg-gray-50 rounded-lg p-2 text-center">
                         <span className="block text-lg font-bold text-gray-800">{c.total_chunks || 0}</span>
                         <span className="text-xs text-gray-500 uppercase tracking-wider">Chunks</span>
                      </div>
                    </div>

                    <div className="flex items-center justify-end gap-2 pt-4 border-t border-gray-100">
                      <button 
                        onClick={() => handleTest(c.id)}
                        className="p-2 text-gray-500 hover:text-blue-600 hover:bg-blue-50 rounded-lg transition-colors"
                        title="Test Connection"
                      >
                        <Icons.Refresh />
                      </button>
                      <button 
                        onClick={() => setEditingConnection(c)}
                        className="p-2 text-gray-500 hover:text-purple-600 hover:bg-purple-50 rounded-lg transition-colors"
                        title="Edit Connection"
                      >
                        <Icons.Edit />
                      </button>
                      <button 
                        onClick={() => handleDelete(c.id)}
                        className="p-2 text-gray-500 hover:text-red-600 hover:bg-red-50 rounded-lg transition-colors"
                        title="Delete Connection"
                      >
                        <Icons.Trash />
                      </button>
                    </div>
                  </div>
                ))}
              </div>
            )}

            {/* Create Modal */}
            <Modal
              isOpen={showAdd}
              onClose={() => setShowAdd(false)}
              title="Add New Connection"
            >
              <form
                onSubmit={(e) => {
                  e.preventDefault();
                  handleCreate();
                }}
                className="space-y-4"
              >
                {/* ... existing form fields ... */}
                {error && (
                  <div className="bg-red-50 text-red-600 text-sm p-3 rounded-lg">
                    {error}
                  </div>
                )}
                <div>
                  <label className="block text-sm font-medium text-gray-700 mb-1">
                    Friendly Name
                  </label>
                  <input
                    type="text"
                    value={form.name}
                    onChange={(e) => setForm({ ...form, name: e.target.value })}
                    className="w-full px-4 py-2 border border-gray-200 rounded-xl focus:ring-2 focus:ring-purple-500"
                    placeholder="e.g. HR Documents"
                  />
                </div>
                <div>
                  <label className="block text-sm font-medium text-gray-700 mb-1">
                    SharePoint Folder URL
                  </label>
                  <input
                    type="text"
                    value={form.folder_url}
                    onChange={(e) => setForm({ ...form, folder_url: e.target.value })}
                    className="w-full px-4 py-2 border border-gray-200 rounded-xl focus:ring-2 focus:ring-purple-500"
                    placeholder="https://company.sharepoint.com/sites/MySite/Shared Documents/Folder"
                  />
                  <p className="text-xs text-gray-500 mt-1">
                    Paste the URL of any folder in your SharePoint site. The tenant will be auto-detected.
                  </p>
                </div>
                <div>
                  <label className="block text-sm font-medium text-gray-700 mb-1">
                    Client ID
                  </label>
                  <input
                    type="text"
                    value={form.client_id}
                    onChange={(e) => setForm({ ...form, client_id: e.target.value })}
                    className="w-full px-4 py-2 border border-gray-200 rounded-xl focus:ring-2 focus:ring-purple-500"
                    placeholder="xxxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxx"
                  />
                </div>
                <div>
                  <label className="block text-sm font-medium text-gray-700 mb-1">
                    Client Secret
                  </label>
                  <input
                    type="password"
                    value={form.client_secret}
                    onChange={(e) => setForm({ ...form, client_secret: e.target.value })}
                    className="w-full px-4 py-2 border border-gray-200 rounded-xl focus:ring-2 focus:ring-purple-500"
                    placeholder="Your client secret"
                  />
                </div>
                <div>
                  <label className="block text-sm font-medium text-gray-700 mb-1">
                    Tenant ID <span className="text-gray-400 font-normal">(optional)</span>
                  </label>
                  <input
                    type="text"
                    value={form.tenant_id}
                    onChange={(e) => setForm({ ...form, tenant_id: e.target.value })}
                    className="w-full px-4 py-2 border border-gray-200 rounded-xl focus:ring-2 focus:ring-purple-500"
                    placeholder="Auto-detected from URL if empty"
                  />
                  <p className="text-xs text-gray-500 mt-1">
                    Leave empty to auto-detect from SharePoint URL, or enter your Azure AD tenant ID/domain.
                  </p>
                </div>
                <button
                  type="submit"
                  disabled={loading}
                  className="w-full bg-purple-600 hover:bg-purple-700 disabled:bg-purple-300 text-white font-medium py-3 rounded-xl flex items-center justify-center gap-2 mt-4"
                >
                  {loading ? <Spinner size="sm" /> : null} Create Connection
                </button>
              </form>
            </Modal>
            
            {/* Edit Modal */}
            <EditConnectionModal 
               isOpen={!!editingConnection}
               onClose={() => setEditingConnection(null)}
               connection={editingConnection}
               onSave={onRefresh}
            />
          </div>
        );
      };

      // ========== SHAREPOINT BROWSER ==========
      const SharePointBrowser = ({ isOpen, onClose, connectionId, onSelect }) => {
        const [drives, setDrives] = useState([]);
        const [currentDrive, setCurrentDrive] = useState(null);
        const [history, setHistory] = useState([{ id: "root", name: "Documents" }]);
        const [items, setItems] = useState({ folders: [], files: [] });
        const [loading, setLoading] = useState(false);
        const [error, setError] = useState(null);

        // Reset state when opening
        useEffect(() => {
            if (isOpen && connectionId) {
                loadDrives();
                setHistory([{ id: "root", name: "Documents" }]);
            }
        }, [isOpen, connectionId]);

        // Load content when drive or folder changes
        useEffect(() => {
            if (currentDrive && history.length > 0) {
                const currentFolder = history[history.length - 1];
                loadContent(currentFolder.id);
            }
        }, [currentDrive, history]);

        const loadDrives = async () => {
            setLoading(true);
            try {
                const res = await api.get(`/api/connections/${connectionId}/drives`);
                setDrives(res);
                if (res.length > 0) {
                    setCurrentDrive(res[0]); // Default to first drive
                }
            } catch (e) {
                setError("Failed to load drives: " + e.message);
            } finally {
                setLoading(false);
            }
        };

        const loadContent = async (folderId) => {
            if (!currentDrive) return;
            setLoading(true);
            setError(null);
            try {
                const res = await api.get(`/api/connections/${connectionId}/browse`, {
                    drive_id: currentDrive.id,
                    folder_id: folderId
                });
                setItems(res);
            } catch (e) {
                setError("Failed to load folder: " + e.message);
            } finally {
                setLoading(false);
            }
        };

        const handleFolderClick = (folder) => {
            setHistory([...history, { id: folder.id, name: folder.name }]);
        };

        const handleBack = () => {
            if (history.length > 1) {
                setHistory(history.slice(0, -1));
            }
        };
        
        const handleBreadcrumbClick = (index) => {
            setHistory(history.slice(0, index + 1));
        };

        const handleSelectCurrent = () => {
             if (!currentDrive) return;
             
             // Construct webUrl based on current folder logic or just use the browser URL logic?
             // Since we need the "web_url" for the import job.
             // The API response for `items` doesn't have the *current* folder's webUrl, only children.
             // But wait, if we are inside a folder, we clicked a folder to get there.
             // We can find the current folder's webUrl from the *previous* folder's items list?
             // Or better, let's just assume the user clicked "Select" on a folder in the LIST.
             // But the user guide says "Select Current Folder" at top is nicer.
             // Let's stick to "Double click to navigate, Single click to select" logic? 
             // Or simpler: "Select" button next to each folder.
             
             // Implementing "Select" button for each folder row is easier.
        };
        
        const handleSelectFolder = (folder) => {
            onSelect(folder.web_url);
            onClose();
        };

        if (!isOpen) return null;

        return (
            <div className="fixed inset-0 bg-black/50 z-50 flex items-center justify-center p-4 backdrop-blur-sm">
                <div className="bg-white rounded-2xl w-full max-w-4xl max-h-[80vh] flex flex-col shadow-2xl animate-fade-in">
                    {/* Header */}
                    <div className="p-4 border-b flex items-center justify-between">
                        <div className="flex items-center gap-3">
                            <h3 className="font-bold text-lg">Browse SharePoint</h3>
                            {drives.length > 1 && (
                                <select 
                                    className="text-sm border rounded-lg px-2 py-1"
                                    value={currentDrive?.id}
                                    onChange={(e) => setCurrentDrive(drives.find(d => d.id === e.target.value))}
                                >
                                    {drives.map(d => <option key={d.id} value={d.id}>{d.name}</option>)}
                                </select>
                            )}
                        </div>
                        <button onClick={onClose} className="p-2 hover:bg-gray-100 rounded-full">
                            <Icons.X />
                        </button>
                    </div>

                    {/* Navigation Bar */}
                    <div className="p-2 bg-gray-50 border-b flex items-center gap-2 overflow-x-auto text-sm">
                         <button 
                            disabled={history.length <= 1}
                            onClick={handleBack}
                            className="p-1 hover:bg-gray-200 rounded disabled:opacity-30"
                         >
                            <Icons.ArrowLeft />
                         </button>
                         <div className="flex items-center text-gray-600">
                            {history.map((h, i) => (
                                <div key={i} className="flex items-center">
                                    {i > 0 && <Icons.ChevronRight />}
                                    <button 
                                        onClick={() => handleBreadcrumbClick(i)}
                                        className={`px-1 hover:underline ${i === history.length - 1 ? 'font-bold text-gray-900' : ''}`}
                                    >
                                        {h.name}
                                    </button>
                                </div>
                            ))}
                         </div>
                    </div>

                    {/* Content List */}
                    <div className="flex-1 overflow-auto p-4 min-h-[300px]">
                        {loading ? (
                            <div className="flex justify-center items-center h-full">
                                <Spinner size="lg" />
                            </div>
                        ) : error ? (
                            <div className="text-red-600 text-center p-4 bg-red-50 rounded-xl">
                                {error}
                            </div>
                        ) : (
                            <div className="grid grid-cols-1 gap-2">
                                {items.folders.length === 0 && items.files.length === 0 && (
                                    <div className="text-center text-gray-400 py-10">
                                        Empty folder
                                    </div>
                                )}
                                
                                {/* Folders */}
                                {items.folders.map(folder => (
                                    <div 
                                        key={folder.id} 
                                        className="flex items-center justify-between p-3 hover:bg-gray-50 rounded-xl border border-transparent hover:border-gray-100 group transition-all"
                                    >
                                        <div 
                                            className="flex items-center gap-3 flex-1 cursor-pointer"
                                            onClick={() => handleFolderClick(folder)}
                                        >
                                            <div className="text-yellow-500 bg-yellow-50 p-2 rounded-lg">
                                                <Icons.Folder />
                                            </div>
                                            <div>
                                                <p className="font-medium text-gray-900">{folder.name}</p>
                                                <p className="text-xs text-gray-400">{folder.child_count} items</p>
                                            </div>
                                        </div>
                                        <button 
                                            onClick={() => handleSelectFolder(folder)}
                                            className="px-3 py-1.5 bg-purple-100 text-purple-700 text-sm font-medium rounded-lg opacity-0 group-hover:opacity-100 transition-opacity hover:bg-purple-200"
                                        >
                                            Select
                                        </button>
                                    </div>
                                ))}

                                {/* Files */}
                                {items.files.map(file => (
                                    <div 
                                        key={file.id} 
                                        className="flex items-center justify-between p-3 hover:bg-gray-50 rounded-xl border border-transparent hover:border-gray-100"
                                    >
                                        <div className="flex items-center gap-3">
                                            <div className="text-blue-500 bg-blue-50 p-2 rounded-lg">
                                                <Icons.File />
                                            </div>
                                            <div>
                                                <p className="text-gray-700">{file.name}</p>
                                                <p className="text-xs text-gray-400">
                                                    {(file.size / 1024).toFixed(1)} KB • {new Date(file.modified_at).toLocaleDateString()}
                                                </p>
                                            </div>
                                        </div>
                                    </div>
                                ))}
                            </div>
                        )}
                    </div>
                </div>
            </div>
        );
      };

      // ========== IMPORT JOBS TAB ==========
      const JobsTab = ({ connections }) => {
        const [jobs, setJobs] = useState([]);
        const [loading, setLoading] = useState(true);
        const [showImport, setShowImport] = useState(false);
        const [form, setForm] = useState({ connection_id: "", folder_url: "" });
        const [importLoading, setImportLoading] = useState(false);
        const [showBrowser, setShowBrowser] = useState(false);

        const loadJobs = async () => {
          try {
            const data = await api.get("/api/import");
            setJobs(data);
          } catch (e) {
            console.error(e);
          } finally {
            setLoading(false);
          }
        };

        useEffect(() => {
          loadJobs();
          const interval = setInterval(loadJobs, 5000); // Poll every 5s
          return () => clearInterval(interval);
        }, []);

        const handleStartImport = async () => {
          if (!form.connection_id || !form.folder_url) return;
          setImportLoading(true);
          try {
            await api.post(`/api/connections/${form.connection_id}/import`, {
              folder_url: form.folder_url,
              recursive: true,
            });
            setShowImport(false);
            setForm({ connection_id: "", folder_url: "" });
            loadJobs();
          } catch (e) {
            alert(e.message);
          } finally {
            setImportLoading(false);
          }
        };

        const handleCancel = async (jobId) => {
          try {
            await api.delete(`/api/import/${jobId}`);
            loadJobs();
          } catch (e) {
            alert(e.message);
          }
        };

        const getProgress = (job) => {
          if (!job.total_files || job.total_files === 0) return 0;
          return Math.round((job.processed_files / job.total_files) * 100);
        };

        return (
          <div className="p-4 space-y-4 pb-24">
            <button
              onClick={() => setShowImport(true)}
              className="w-full bg-purple-600 hover:bg-purple-700 text-white font-medium py-3 rounded-xl flex items-center justify-center gap-2 touch-btn"
            >
              <Icons.Download /> Start Import
            </button>

            {loading ? (
              <div className="flex justify-center py-8">
                <Spinner />
              </div>
            ) : jobs.length === 0 ? (
              <div className="bg-white rounded-xl p-8 card-shadow text-center">
                <Icons.Jobs />
                <p className="mt-4 text-gray-500">No import jobs</p>
                <p className="text-sm text-gray-400">
                  Start an import to index documents
                </p>
              </div>
            ) : (
              <div className="space-y-3">
                {jobs.map((job) => (
                  <div
                    key={job.id}
                    className="bg-white rounded-xl p-4 card-shadow"
                  >
                    <div className="flex items-start justify-between mb-2">
                      <div>
                        <p className="font-semibold">
                          {job.folder_name || "Import"}
                        </p>
                        <p className="text-xs text-gray-400 mt-1">
                          {new Date(job.created_at).toLocaleString()}
                        </p>
                      </div>
                      <StatusBadge status={job.status} />
                    </div>

                    {(job.status === "processing" ||
                      job.status === "running") && (
                      <div className="mt-3">
                        <div className="flex justify-between text-sm text-gray-600 mb-1">
                          <span>
                            {job.processed_files || 0} /{" "}
                            {job.total_files || "?"} files
                          </span>
                          <span>{getProgress(job)}%</span>
                        </div>
                        <div className="h-2 bg-gray-100 rounded-full overflow-hidden">
                          <div
                            className="h-full bg-purple-500 progress-bar rounded-full"
                            style={{ width: `${getProgress(job)}%` }}
                          ></div>
                        </div>
                      </div>
                    )}

                    {job.status === "completed" && (
                      <div className="flex gap-2 mt-3 text-sm">
                        <span className="bg-green-100 text-green-700 px-2 py-1 rounded">
                          {job.processed_files} files indexed
                        </span>
                      </div>
                    )}

                    {job.status === "failed" && job.error && (
                      <p className="text-sm text-red-600 mt-2">{job.error}</p>
                    )}

                    {(job.status === "processing" ||
                      job.status === "running" ||
                      job.status === "pending") && (
                      <div className="mt-3 pt-3 border-t">
                        <button
                          onClick={() => handleCancel(job.id)}
                          className="text-sm text-red-600 font-medium hover:underline"
                        >
                          Cancel
                        </button>
                      </div>
                    )}
                  </div>
                ))}
              </div>
            )}

            <Modal
              isOpen={showImport}
              onClose={() => setShowImport(false)}
              title="Start Import"
            >
              <div className="space-y-4">
                <div>
                  <label className="block text-sm font-medium mb-1">
                    Connection
                  </label>
                  <select
                    value={form.connection_id}
                    onChange={(e) =>
                      setForm({ ...form, connection_id: e.target.value })
                    }
                    className="w-full px-4 py-3 border rounded-xl"
                  >
                    <option value="">Select connection...</option>
                    {connections.map((c) => (
                      <option key={c.id} value={c.id}>
                        {c.name}
                      </option>
                    ))}
                  </select>
                </div>
                <div>
                  <label className="block text-sm font-medium mb-1">
                    SharePoint Folder URL
                  </label>
                  <input
                    value={form.folder_url}
                    onChange={(e) =>
                      setForm({ ...form, folder_url: e.target.value })
                    }
                    className="w-full px-4 py-3 border rounded-xl"
                    placeholder="https://company.sharepoint.com/sites/..."
                  />
                  <button
                    onClick={() => {
                        if (!form.connection_id) {
                            alert("Please select a connection first");
                            return;
                        }
                        setShowBrowser(true);
                    }}
                    className="absolute right-2 top-[29px] p-2 text-purple-600 hover:bg-purple-50 rounded-lg text-sm font-medium"
                  >
                    Browse
                  </button>
                </div>
                </div>
                <button
                  onClick={handleStartImport}
                  disabled={importLoading}
                  className="w-full bg-purple-600 hover:bg-purple-700 disabled:bg-purple-300 text-white font-medium py-3 rounded-xl flex items-center justify-center gap-2"
                >
                  {importLoading ? <Spinner size="sm" /> : <Icons.Play />} Start
                  Import
                </button>
              </div>
            </Modal>

            {/* SharePoint Browser Modal */}
            <SharePointBrowser
                isOpen={showBrowser}
                onClose={() => setShowBrowser(false)}
                connectionId={form.connection_id}
                onSelect={(url) => setForm({ ...form, folder_url: url })}
            />
          </div>
        );
      };

      // ========== QUERY TAB ==========
      const QueryTab = () => {
        const [query, setQuery] = useState("");
        const [result, setResult] = useState(null);
        const [loading, setLoading] = useState(false);
        const [filters, setFilters] = useState({ file_types: [] });
        const [showFilters, setShowFilters] = useState(false);

        const handleQuery = async () => {
          if (!query.trim() || loading) return;
          setLoading(true);
          try {
            const payload = { query, top_k: 5 };
            if (filters.file_types.length > 0) {
              payload.filters = { file_types: filters.file_types };
            }
            const res = await api.post("/api/query", payload);
            setResult(res);
          } catch (e) {
            setResult({ error: e.message });
          } finally {
            setLoading(false);
          }
        };

        const toggleFileType = (type) => {
          setFilters((prev) => ({
            ...prev,
            file_types: prev.file_types.includes(type)
              ? prev.file_types.filter((t) => t !== type)
              : [...prev.file_types, type],
          }));
        };

        return (
          <div className="flex flex-col h-full">
            <div className="flex-1 overflow-auto p-4 pb-40">
              {result ? (
                <div className="slide-up space-y-4">
                  {result.error ? (
                    <div className="bg-red-50 text-red-600 p-4 rounded-xl">
                      {result.error}
                    </div>
                  ) : (
                    <>
                      <div className="bg-white rounded-xl p-4 card-shadow">
                        <p className="text-sm text-gray-500 mb-2">Answer</p>
                        <p className="whitespace-pre-wrap">{result.answer}</p>
                        {result.timing && (
                          <p className="text-xs text-gray-400 mt-3">
                            Total: {result.timing.total_ms?.toFixed(0)}ms
                          </p>
                        )}
                      </div>
                      {result.sources?.length > 0 && (
                        <div className="space-y-2">
                          <p className="text-sm font-medium text-gray-700">
                            Sources ({result.sources.length})
                          </p>
                          {result.sources.map((s, i) => (
                            <div
                              key={i}
                              className="bg-white rounded-xl p-3 card-shadow"
                            >
                              <div className="flex items-start gap-2">
                                <span className="bg-purple-100 text-purple-700 text-xs font-bold px-2 py-0.5 rounded">
                                  {s.index}
                                </span>
                                <div className="flex-1">
                                  <p className="font-medium text-sm">
                                    {s.document_name}
                                  </p>
                                  {s.page_number && (
                                    <p className="text-xs text-gray-400">
                                      Page {s.page_number}
                                    </p>
                                  )}
                                  <p className="text-xs text-gray-500 mt-1">
                                    {s.excerpt}
                                  </p>
                                  <p className="text-xs text-purple-600 mt-1">
                                    Score: {(s.score * 100).toFixed(1)}%
                                  </p>
                                </div>
                              </div>
                            </div>
                          ))}
                        </div>
                      )}
                    </>
                  )}
                </div>
              ) : (
                <div className="flex flex-col items-center justify-center py-12 text-center text-gray-500">
                  <Icons.Search />
                  <p className="mt-4 font-medium">Ask a Question</p>
                  <p className="text-sm text-gray-400 mt-1">
                    Query your indexed SharePoint documents
                  </p>
                </div>
              )}
            </div>

            {/* Filter Bar */}
            <div className="fixed bottom-28 left-0 right-0 bg-gray-50 border-t px-4 py-2">
              <div className="flex gap-2 overflow-x-auto">
                {["pdf", "docx", "xlsx", "pptx", "txt"].map((type) => (
                  <button
                    key={type}
                    onClick={() => toggleFileType(type)}
                    className={`px-3 py-1 rounded-full text-xs font-medium whitespace-nowrap ${
                      filters.file_types.includes(type)
                        ? "bg-purple-600 text-white"
                        : "bg-gray-200 text-gray-600"
                    }`}
                  >
                    .{type}
                  </button>
                ))}
              </div>
            </div>

            {/* Input Bar */}
            <div className="fixed bottom-16 left-0 right-0 bg-white border-t p-4 safe-bottom">
              <div className="flex gap-2 max-w-lg mx-auto">
                <input
                  type="text"
                  value={query}
                  onChange={(e) => setQuery(e.target.value)}
                  onKeyPress={(e) => e.key === "Enter" && handleQuery()}
                  placeholder="Ask a question..."
                  className="flex-1 px-4 py-3 border border-gray-200 rounded-xl focus:ring-2 focus:ring-purple-500"
                />
                <button
                  onClick={handleQuery}
                  disabled={loading || !query.trim()}
                  className="bg-purple-600 hover:bg-purple-700 disabled:bg-gray-300 text-white px-4 rounded-xl touch-btn flex items-center justify-center"
                >
                  {loading ? <Spinner size="sm" /> : <Icons.Send />}
                </button>
              </div>
            </div>
          </div>
        );
      };

      // ========== SETTINGS TAB ==========
      const SettingsTab = ({ user, onLogout }) => (
        <div className="p-4 space-y-4 pb-24">
          <div className="bg-white rounded-xl p-4 card-shadow flex items-center gap-4">
            <div className="w-14 h-14 rounded-full bg-purple-100 flex items-center justify-center text-purple-600">
              <Icons.User />
            </div>
            <div>
              <p className="font-semibold text-lg">{user?.name || "Guest"}</p>
              <p className="text-sm text-gray-500">
                {user?.email || "Not logged in"}
              </p>
            </div>
          </div>
          <div className="bg-white rounded-xl card-shadow overflow-hidden divide-y">
            <a
              href="/docs"
              target="_blank"
              className="w-full flex items-center justify-between px-4 py-4 hover:bg-gray-50"
            >
              <span>API Documentation</span>
              <Icons.ChevronRight />
            </a>
            <button className="w-full flex items-center justify-between px-4 py-4 hover:bg-gray-50">
              <span>Notifications</span>
              <Icons.ChevronRight />
            </button>
            <button className="w-full flex items-center justify-between px-4 py-4 hover:bg-gray-50">
              <span>API Keys</span>
              <Icons.ChevronRight />
            </button>
            <button
              onClick={onLogout}
              className="w-full flex items-center gap-3 px-4 py-4 text-red-600 hover:bg-red-50"
            >
              <Icons.Logout />
              <span>Sign Out</span>
            </button>
          </div>
          <div className="text-center text-sm text-gray-400 py-4">
            <p>SharePoint RAG v2.0</p>
            <p className="text-xs mt-1">Phase 4 Dashboard</p>
          </div>
        </div>
      );

      // ========== MAIN APP ==========
      const App = () => {
        const [user, setUser] = useState(null);
        const [isLoggedIn, setIsLoggedIn] = useState(!!getToken());
        const [activeTab, setActiveTab] = useState("home");
        const [connections, setConnections] = useState([]);
        const [stats, setStats] = useState({});
        const [loading, setLoading] = useState(true);

        const loadData = useCallback(async () => {
          try {
            const [conns, vs] = await Promise.all([
              api.get("/api/connections").catch(() => []),
              api.get("/api/query/stats").catch(() => ({})),
            ]);
            setConnections(conns);
            setStats(vs);
          } catch (e) {
            console.error(e);
          } finally {
            setLoading(false);
          }
        }, []);

        useEffect(() => {
          if (isLoggedIn) loadData();
        }, [isLoggedIn, loadData]);

        const handleLogin = (u) => {
          setUser(u);
          setIsLoggedIn(true);
        };
        const handleLogout = () => {
          clearToken();
          setUser(null);
          setIsLoggedIn(false);
        };

        if (!isLoggedIn) return <LoginPage onLogin={handleLogin} />;

        const tabs = [
          { id: "home", icon: <Icons.Home />, label: "Home" },
          { id: "connections", icon: <Icons.Link />, label: "Connections" },
          { id: "jobs", icon: <Icons.Jobs />, label: "Jobs" },
          { id: "query", icon: <Icons.Search />, label: "Query" },
          { id: "settings", icon: <Icons.Settings />, label: "Settings" },
        ];

        return (
          <div className="min-h-screen bg-gray-50 safe-top">
            <header className="gradient-bg text-white px-4 py-4 sticky top-0 z-10 flex items-center justify-between">
              <h1 className="text-xl font-bold">SharePoint RAG</h1>
              <button
                onClick={loadData}
                className="w-10 h-10 rounded-full bg-white/20 flex items-center justify-center touch-btn"
              >
                <Icons.Refresh />
              </button>
            </header>
            <main className="pb-20">
              {loading ? (
                <div className="flex items-center justify-center py-20">
                  <Spinner />
                </div>
              ) : (
                <>
                  {activeTab === "home" && (
                    <HomeTab
                      stats={stats}
                      connections={connections}
                      onRefresh={loadData}
                    />
                  )}
                  {activeTab === "connections" && (
                    <ConnectionsTab
                      connections={connections}
                      onRefresh={loadData}
                    />
                  )}
                  {activeTab === "jobs" && (
                    <JobsTab connections={connections} />
                  )}
                  {activeTab === "query" && <QueryTab />}
                  {activeTab === "settings" && (
                    <SettingsTab user={user} onLogout={handleLogout} />
                  )}
                </>
              )}
            </main>
            <nav className="fixed bottom-0 left-0 right-0 bg-white mobile-nav safe-bottom">
              <div className="flex justify-around">
                {tabs.map((t) => (
                  <button
                    key={t.id}
                    onClick={() => setActiveTab(t.id)}
                    className={`flex-1 flex flex-col items-center py-2 touch-btn ${
                      activeTab === t.id ? "text-purple-600" : "text-gray-400"
                    }`}
                  >
                    {t.icon}
                    <span className="text-xs mt-0.5">{t.label}</span>
                  </button>
                ))}
              </div>
            </nav>
          </div>
        );
      };

      ReactDOM.createRoot(document.getElementById("root")).render(<App />);
    </script>
  </body>
</html>
